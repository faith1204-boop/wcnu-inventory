// ============================================
// ìš°ì •ìº„ë³´ë””ì•„ ê°„í˜¸ëŒ€í•™êµ - í†µí•© ë¬¼í’ˆê´€ë¦¬ ì‹œìŠ¤í…œ
// Google Apps Script - ì™„ì „ í†µí•© ë²„ì „
// ê¸°ëŠ¥: ë¬¼í’ˆ ê´€ë¦¬ + ì´ë ¥ì¹´ë“œ ì¶œë ¥
// ============================================

// â­â­â­ ì‹œíŠ¸ ì´ë¦„ ì„¤ì • â­â­â­
const SHEET_NAME = 'Item_list';

// ============================================
// GET ìš”ì²­: ë°ì´í„° ì¡°íšŒ
// ============================================
function doGet(e) {
  Logger.log('===== doGet í˜¸ì¶œë¨ =====');
  
  if (!e) {
    e = { parameter: {} };
  }
  
  Logger.log('Parameters: ' + JSON.stringify(e.parameter || {}));
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = spreadsheet.getSheetByName(SHEET_NAME);
    
    if (!sheet) {
      Logger.log('âŒ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ' + SHEET_NAME);
      const availableSheets = spreadsheet.getSheets().map(s => s.getName());
      
      return createJsonResponse({ 
        success: false, 
        error: 'ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + SHEET_NAME,
        availableSheets: availableSheets
      });
    }
    
    const action = e.parameter.action;
    
    // ì‚¬ì§„ ë°ì´í„°ë§Œ ìš”ì²­í•˜ëŠ” ê²½ìš° (ë¬¼í’ˆì´ë ¥ì¹´ë“œìš©)
    if (action === 'getPhotos') {
      Logger.log('ğŸ“¸ ì‚¬ì§„ ë°ì´í„° ìš”ì²­');
      const photoData = getPhotoData(sheet);
      return createJsonResponse({ 
        success: true,
        photos: photoData 
      });
    }
    
    // ì „ì²´ ë°ì´í„° ìš”ì²­ (ê¸°ë³¸)
    Logger.log('ğŸ“‹ ì „ì²´ ë°ì´í„° ìš”ì²­');
    const inventoryData = getInventoryData(sheet);
    
    return createJsonResponse({
      success: true,
      data: inventoryData,
      totalRows: inventoryData.length,
      timestamp: new Date().toISOString()
    });
    
  } catch (error) {
    Logger.log('âŒ ì˜¤ë¥˜ ë°œìƒ: ' + error.toString());
    return createJsonResponse({ 
      success: false, 
      error: error.toString(),
      stack: error.stack
    });
  }
}

// ============================================
// POST ìš”ì²­: ë°ì´í„° ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ
// ============================================
function doPost(e) {
  Logger.log('===== doPost í˜¸ì¶œë¨ =====');
  
  const output = ContentService.createTextOutput();
  output.setMimeType(ContentService.MimeType.JSON);
  
  if (!e || !e.postData) {
    Logger.log('âš ï¸ POST ë°ì´í„° ì—†ìŒ');
    return output.setContent(JSON.stringify({ 
      success: false, 
      error: 'POST ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
    }));
  }
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = spreadsheet.getSheetByName(SHEET_NAME);
    
    if (!sheet) {
      throw new Error('ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + SHEET_NAME);
    }
    
    const params = JSON.parse(e.postData.contents);
    const action = params.action;
    
    Logger.log('âœ… Action: ' + action);
    
    let result;
    
    switch(action) {
      case 'add':
        result = addItem(sheet, params.data);
        break;
      case 'update':
        result = updateItem(sheet, params.data);
        break;
      case 'delete':
        result = deleteItem(sheet, params.id);
        break;
      default:
        throw new Error('ì•Œ ìˆ˜ ì—†ëŠ” ì•¡ì…˜ì…ë‹ˆë‹¤: ' + action);
    }
    
    return output.setContent(JSON.stringify({
      success: true,
      action: action,
      message: result,
      timestamp: new Date().toISOString()
    }));
    
  } catch (error) {
    Logger.log('âŒ ì˜¤ë¥˜: ' + error.toString());
    return output.setContent(JSON.stringify({
      success: false,
      error: error.toString(),
      stack: error.stack
    }));
  }
}

// ============================================
// ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜ë“¤
// ============================================

// ì „ì²´ ë¬¼í’ˆ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
function getInventoryData(sheet) {
  const data = sheet.getDataRange().getValues();
  
  if (data.length === 0) {
    return [];
  }
  
  const headers = data[0];
  const rows = data.slice(1);
  
  const inventory = rows.map(row => {
    const item = {};
    headers.forEach((header, index) => {
      item[header] = row[index];
    });
    return item;
  }).filter(item => {
    return item['ë¬¼í’ˆì½”ë“œ'] && item['ë¬¼í’ˆì½”ë“œ'].toString().trim() !== '';
  });
  
  Logger.log('âœ… ë°ì´í„° ìˆ˜: ' + inventory.length);
  return inventory;
}

// ì‚¬ì§„ ë°ì´í„°ë§Œ ì¶”ì¶œ (ë¬¼í’ˆì´ë ¥ì¹´ë“œìš©)
function getPhotoData(sheet) {
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const rows = data.slice(1);
  
  const codeIndex = headers.indexOf('ë¬¼í’ˆì½”ë“œ');
  const photoIndex = headers.indexOf('ì‚¬ì§„');
  
  if (codeIndex === -1) {
    Logger.log('âš ï¸ ë¬¼í’ˆì½”ë“œ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
    return {};
  }
  
  const photoData = {};
  
  rows.forEach(row => {
    const code = row[codeIndex];
    const photo = photoIndex !== -1 ? row[photoIndex] : '';
    if (code && photo) {
      photoData[code] = photo;
    }
  });
  
  Logger.log('âœ… ì‚¬ì§„ ë°ì´í„° ìˆ˜: ' + Object.keys(photoData).length);
  return photoData;
}

// ë¬¼í’ˆ ì¶”ê°€
function addItem(sheet, data) {
  Logger.log('ğŸ“ ìƒˆ ë¬¼í’ˆ ì¶”ê°€ ì‹œì‘...');
  
  const newRow = [
    data.code || '',
    data.nameKo || '',
    data.nameKh || '',
    data.category || '',
    data.quantity || 0,
    data.minQuantity || 0,
    data.location || '',
    data.price || 0,
    data.purchaseDate || '',
    data.createdDate || new Date().toISOString(),
    data.notes || '',
    data.photo || '',
    data.id || Date.now()
  ];
  
  sheet.appendRow(newRow);
  SpreadsheetApp.flush();
  
  Logger.log('âœ… ì¶”ê°€ ì™„ë£Œ: ' + data.code);
  return 'ë¬¼í’ˆì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.';
}

// ë¬¼í’ˆ ìˆ˜ì •
function updateItem(sheet, data) {
  Logger.log('ğŸ“ ë¬¼í’ˆ ìˆ˜ì • ì‹œì‘...');
  
  const allData = sheet.getDataRange().getValues();
  const headers = allData[0];
  const idColumnIndex = headers.indexOf('ID (ìˆ¨ê¹€)');
  
  if (idColumnIndex === -1) {
    throw new Error('ID ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
  
  for (let i = 1; i < allData.length; i++) {
    if (allData[i][idColumnIndex] == data.id) {
      const rowNumber = i + 1;
      
      sheet.getRange(rowNumber, 1).setValue(data.code || '');
      sheet.getRange(rowNumber, 2).setValue(data.nameKo || '');
      sheet.getRange(rowNumber, 3).setValue(data.nameKh || '');
      sheet.getRange(rowNumber, 4).setValue(data.category || '');
      sheet.getRange(rowNumber, 5).setValue(data.quantity || 0);
      sheet.getRange(rowNumber, 6).setValue(data.minQuantity || 0);
      sheet.getRange(rowNumber, 7).setValue(data.location || '');
      sheet.getRange(rowNumber, 8).setValue(data.price || 0);
      sheet.getRange(rowNumber, 9).setValue(data.purchaseDate || '');
      sheet.getRange(rowNumber, 10).setValue(data.createdDate || '');
      sheet.getRange(rowNumber, 11).setValue(data.notes || '');
      sheet.getRange(rowNumber, 12).setValue(data.photo || '');
      
      SpreadsheetApp.flush();
      Logger.log('âœ… ìˆ˜ì • ì™„ë£Œ: í–‰ ' + rowNumber);
      return 'ë¬¼í’ˆì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.';
    }
  }
  
  throw new Error('í•´ë‹¹ IDì˜ ë¬¼í’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + data.id);
}

// ë¬¼í’ˆ ì‚­ì œ
function deleteItem(sheet, itemId) {
  Logger.log('ğŸ—‘ï¸ ë¬¼í’ˆ ì‚­ì œ ì‹œì‘...');
  
  const allData = sheet.getDataRange().getValues();
  const headers = allData[0];
  const idColumnIndex = headers.indexOf('ID (ìˆ¨ê¹€)');
  
  if (idColumnIndex === -1) {
    throw new Error('ID ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
  
  for (let i = 1; i < allData.length; i++) {
    if (allData[i][idColumnIndex] == itemId) {
      sheet.deleteRow(i + 1);
      SpreadsheetApp.flush();
      Logger.log('âœ… ì‚­ì œ ì™„ë£Œ: í–‰ ' + (i + 1));
      return 'ë¬¼í’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.';
    }
  }
  
  throw new Error('í•´ë‹¹ IDì˜ ë¬¼í’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + itemId);
}

// ============================================
// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
// ============================================

// JSON ì‘ë‹µ ìƒì„± (CORS í—ˆìš©)
function createJsonResponse(data) {
  const output = ContentService.createTextOutput(JSON.stringify(data));
  output.setMimeType(ContentService.MimeType.JSON);
  return output;
}

// ============================================
// í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤
// ============================================

// GET í…ŒìŠ¤íŠ¸
function testDoGet() {
  Logger.log('ğŸ“‹ ===== testDoGet ì‹œì‘ =====');
  const result = doGet({});
  const content = result.getContent();
  
  try {
    const parsed = JSON.parse(content);
    if (parsed.success) {
      Logger.log('âœ… ì„±ê³µ! ë°ì´í„° ìˆ˜: ' + (parsed.data ? parsed.data.length : 0));
    } else {
      Logger.log('âŒ ì‹¤íŒ¨: ' + parsed.error);
    }
  } catch (e) {
    Logger.log('âš ï¸ íŒŒì‹± ì˜¤ë¥˜: ' + e.toString());
  }
  
  Logger.log('ğŸ“‹ ===== testDoGet ì™„ë£Œ =====');
}

// POST í…ŒìŠ¤íŠ¸
function testDoPost() {
  Logger.log('ğŸ“ ===== testDoPost ì‹œì‘ =====');
  
  const testId = Date.now();
  
  const testData = {
    parameter: {},
    postData: {
      type: 'application/json',
      contents: JSON.stringify({
        action: 'add',
        data: {
          id: testId,
          code: 'TEST-' + testId,
          nameKo: 'í…ŒìŠ¤íŠ¸ ë¬¼í’ˆ',
          nameKh: 'áŸá˜áŸ’á—á¶ášáŸˆáŸá¶á€á›áŸ’á”á„',
          category: 'medical',
          quantity: 10,
          minQuantity: 5,
          location: 'ì°½ê³ A',
          price: 100,
          purchaseDate: '2024-12-27',
          createdDate: new Date().toISOString(),
          notes: 'í…ŒìŠ¤íŠ¸ìš©',
          photo: ''
        }
      })
    }
  };
  
  const result = doPost(testData);
  const content = result.getContent();
  
  try {
    const parsed = JSON.parse(content);
    if (parsed.success) {
      Logger.log('âœ…âœ…âœ… ì„±ê³µ! âœ…âœ…âœ…');
    } else {
      Logger.log('âŒ ì‹¤íŒ¨: ' + parsed.error);
    }
  } catch (e) {
    Logger.log('âš ï¸ íŒŒì‹± ì˜¤ë¥˜: ' + e.toString());
  }
  
  Logger.log('ğŸ“ ===== testDoPost ì™„ë£Œ =====');
}

// ì‚¬ì§„ ë°ì´í„° í…ŒìŠ¤íŠ¸
function testGetPhotos() {
  Logger.log('ğŸ“¸ ===== testGetPhotos ì‹œì‘ =====');
  const result = doGet({ parameter: { action: 'getPhotos' } });
  const content = result.getContent();
  
  try {
    const parsed = JSON.parse(content);
    if (parsed.success) {
      Logger.log('âœ… ì„±ê³µ! ì‚¬ì§„ ìˆ˜: ' + Object.keys(parsed.photos || {}).length);
      Logger.log('ì‚¬ì§„ ë°ì´í„°: ' + JSON.stringify(parsed.photos));
    } else {
      Logger.log('âŒ ì‹¤íŒ¨: ' + parsed.error);
    }
  } catch (e) {
    Logger.log('âš ï¸ íŒŒì‹± ì˜¤ë¥˜: ' + e.toString());
  }
  
  Logger.log('ğŸ“¸ ===== testGetPhotos ì™„ë£Œ =====');
}

// ì „ì²´ í…ŒìŠ¤íŠ¸
function testAll() {
  Logger.log('ğŸ§ª ===== ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹œì‘ =====');
  Logger.log('');
  
  Logger.log('1ï¸âƒ£ ë°ì´í„° ì½ê¸° í…ŒìŠ¤íŠ¸...');
  testDoGet();
  Logger.log('');
  
  Logger.log('2ï¸âƒ£ ì‚¬ì§„ ë°ì´í„° í…ŒìŠ¤íŠ¸...');
  testGetPhotos();
  Logger.log('');
  
  Logger.log('3ï¸âƒ£ ë°ì´í„° ì“°ê¸° í…ŒìŠ¤íŠ¸...');
  testDoPost();
  Logger.log('');
  
  Logger.log('ğŸ§ª ===== ì „ì²´ í…ŒìŠ¤íŠ¸ ì™„ë£Œ =====');
}

// ì‹œíŠ¸ ì •ë³´ í™•ì¸
function checkSheetInfo() {
  Logger.log('ğŸ“Š ===== ì‹œíŠ¸ ì •ë³´ í™•ì¸ =====');
  
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  Logger.log('Spreadsheet: ' + spreadsheet.getName());
  Logger.log('ID: ' + spreadsheet.getId());
  
  const sheets = spreadsheet.getSheets();
  Logger.log('ì´ ì‹œíŠ¸: ' + sheets.length + 'ê°œ');
  
  sheets.forEach((sheet, index) => {
    Logger.log('');
    Logger.log('ì‹œíŠ¸ #' + (index + 1) + ': ' + sheet.getName());
    Logger.log('  í–‰: ' + sheet.getLastRow());
    Logger.log('  ì—´: ' + sheet.getLastColumn());
    
    if (sheet.getName() === SHEET_NAME) {
      Logger.log('  â­ ì‚¬ìš© ì¤‘ì¸ ì‹œíŠ¸!');
      
      if (sheet.getLastRow() > 0) {
        const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
        Logger.log('  í—¤ë”: ' + JSON.stringify(headers));
      }
    }
  });
  
  Logger.log('');
  Logger.log('ğŸ“Š ===== í™•ì¸ ì™„ë£Œ =====');
}
